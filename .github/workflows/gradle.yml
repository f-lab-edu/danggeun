# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will build a Java project with Gradle and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle

name: Java CI with Gradle And Code Coverage comment

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

# (Workflow + branch) í•˜ë‚˜ë§Œ ë™ì‘
# ë™ì¼í•œ group ì˜ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ê¸°ì¡´ Runner Cancel ì²˜ë¦¬
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Gradle build and test
  build:
    runs-on: ubuntu-latest
    steps:
      # Git Project Clone
      - uses: actions/checkout@v3
      # Java install
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      # Project Build and Test
      - name: Build with Gradle
        uses: gradle/gradle-build-action@bd5760595778326ba7f1441bcf7e88b49de61a25 # v2.6.0
        with:
          arguments: build
      # Jar íŒŒì¼ ì—…ë¡œë“œ
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: danggeun-artifact
          path: build/libs/*.jar

  # Jacoco coverage
  coverage:
    runs-on: ubuntu-latest
    # build ì²˜ë¦¬ í›„ ì§„í–‰
    needs: build
    # Git event ê°€ PR ì¸ ê²½ìš°ì—ë§Œ ë¦¬í¬íŠ¸ ì½”ë©˜íŠ¸ ë“±ë¡
    if: github.event_name == 'pull_request'
    steps:
      - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ë¥¼ PRì— ì½”ë©˜íŠ¸ë¡œ ë“±ë¡í•©ë‹ˆë‹¤
        id: jacoco
        uses: madrapps/jacoco-report@v1.2
        with:
          title: ğŸ“ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤
          paths: ${{ github.workspace }}/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 10
          min-coverage-changed-files: 10

  deploy:
    runs-on: ubuntu-latest
    # build ì²˜ë¦¬ í›„ ì§„í–‰
    needs: build
    # Git event ê°€ Push ì¸ ê²½ìš° ë°°í¬ ì§„í–‰
    if: github.event_name != 'pull_request'
    # ${{ github.workflow }} + deploy í•˜ë‚˜ì˜ Workflow ì—ì„œ deploy ì‘ì—…ì´ ê²¹ì¹˜ë©´ ì´ì „ Workflow Cancel
    concurrency:
      group: ${{ github.workflow }}-depoly
      cancel-in-progress: true

    steps:
      # Upload í•œ artifact Download
      - name: Download artifact
        uses: actions/download-artifact@v2
        with:
          name: danggeun-artifact
      # SSH ì—°ê²° ì‹œ Agent ì ìš©
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.DANGGEUN_SSH_PRIVATE_KEY }}
      # Downlaoded artifact ì„œë²„ì— ì „ë‹¬
      # path : /home/project/
      - name: SCP transfer
        run: scp -P ${{ secrets.SERVER_PORT }} -o StrictHostKeyChecking=no ${{ secrets.FILE_NAME }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:${{ secrets.FILE_PATH }}
      # ì„œë²„ ì¢…ë£Œ ë° ì¬ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: executing remote ssh commands server stop and restart
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DANGGEUN_SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "> í˜„ì¬ êµ¬ë™ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ PID í™•ì¸"
            CURRENT_PID=$(lsof -i tcp:8080 | awk 'NR!=1 {print$2}')
            
            echo "í˜„ì¬ êµ¬ë™ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ PID : $CURRENT_PID"
            if [ -z "$CURRENT_PID" ]; then
              echo "> í˜„ì¬ êµ¬ë™ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì—†ìœ¼ë¯€ë¡œ ì¢…ë£Œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            else
              echo "> kill -9 $CURRENT_PID"
              kill -9 $CURRENT_PID
              sleep 5
            fi
            
            echo "> ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ë™"
            nohup java -jar ${{ secrets.FILE_PATH }} -spring.profiles.active=dev &